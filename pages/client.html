<audio id="ping">
	<source src="/assets/ping.mp3" type="audio/mpeg">
</audio>
<html>
	<head>
		<title>NetTalk</title>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
	</head>
	<body id="bg">
		<style>
		
		span.b {
			text-shadow: 2px, 2px, black;
			font-size: 20px;
		}
		
		txt {
			text-transform: capitalize;
			letter-spacing: 2px;
			font-family: Arial, Helvetica, sans-serif;
		}
		#bg {
			background-color: rgb(69,75,0);
			background-image: linear-gradient(Fuchsia, CornflowerBlue);
			margin: 2;
			background-repeat: no-repeat;
			background-attachment: fixed;
		}
		body {
			background-color: Gold;
		} 
		
		
		button {
			background-image: linear-gradient(GoldenRod, Gold);
			border: none;
			color: white;
			padding: 4px 30px;
			text-align: center;
			text-decoration: none;
			display: inline-block;
			font-size: 16px;
			margin: 4px 2px;
			border: 1px solid #ccc;
			border-radius: 4px;
			box-sizing: border-box;
		}
		input {
			width: 960px;
			padding: 4px 2px;
			display: inline-block;
			border: 1px solid #ccc;
			border-radius: 4px;
			box-sizing: border-box;
		}
		span.credits {
			font-size: 12px;
			color: light_gray;
		}
		span.credits+ {
			font-size: 20px;
			color: black;
		}
		a.credits {
			font-size: 14px;
			color: light_gray;
		}
		</style>
		<script type="text/javascript">
			var pings;
			let socket;
			var userlist;
			
	
			function isHTML(str) {
				var doc = new DOMParser().parseFromString(str, "text/html");
				return Array.from(doc.body.childNodes).some(node => node.nodeType === 1);
			}
			username = {};
			var users;
			canuse = true;
			function getRandomInt(max) {
				return Math.floor(Math.random() * Math.floor(max));
			}

			
			$(document).ready(function(){
			var go = prompt("By using this service, you agree to the ToS. To read them, please enter 1, so you will be NOT connected. To continue normally, enter 0")
			if(go == 1){
				const socket = "disabled"
			}
			if(go == 0){
				socket = io.connect('http://' + document.domain + ":" + location.port, {'sync disconnect on unload': true });
			}
			setInterval(function(){
				socket.emit('request_user_list')
			}, 250)
			socket.on('receive_user_list', function(user_list){
				unformatted_userlist = user_list.split(',')
				userlist = []
				for(i=0; i<unformatted_userlist.length; i++){
					userlist.push("<br>" + unformatted_userlist[i])
				}
				document.getElementById('user_list').innerHTML = userlist.toString()
				users = user_list.split(',')
				if(users[0] != "Core Bot"){
					users.unshift("Core Bot")
				}
			});
			len = 33
			
			do {
				username = prompt("Please enter your username (or leave blank to enter as guest)");

				len = username.length
			} while(len > 32)
			//console.log(users)
			//for(i=0; i<users.length; i++){
				//console.log(username)
				//console.log(users[i].toString())
				//console.log(users[i])
				//if(username == users[i].toString()) {
					//alert("User exists. Logging in as Guest");
					//username = null;
				//}
			//}
			
			if(username == null || username == "" || isHTML(username) || username == undefined){
				username = "Guest" + getRandomInt(32768)
			}
			console.log(username)
			socket.emit('get_username', username)
			socket.emit('logon', username)
			socket.on('connect', function(){
				socket.emit('request_user_list', username)
			});
			// stuff //
			String.prototype.replaceAll = function(search, replacement) {
			var target = this;
			return target.replace(new RegExp(search, 'g'), replacement);
			};

			function replaceAll(str, map){
				for(key in map){
					str = str.replaceAll(key, map[key]);
				}
				return str;
			}
			// --- //
            $('#send').on('click', function(){
				msg = document.getElementById('user_message').value
				emoji = {':grin:' : 'ðŸ˜€', ':joy:' : 'ðŸ˜‚', ':smiley:' : 'ðŸ™‚', ':wink:' : 'ðŸ˜‰', ':sunglasses:' : 'ðŸ˜Ž', ':neutral:' : 'ðŸ˜‘', ':sad:' : 'ðŸ™', ':angry:' : 'ðŸ˜¡', ':cry:' : 'ðŸ˜¥', ':shrug:' : 'ðŸ¤·', ':thinking:' : 'ðŸ¤”', ':100:' : 'ðŸ’¯', ':fire:' : 'ðŸ”¥'}
				if(isHTML(msg)) {
					return;
				}
				if(!msg.startsWith(' ') && msg != ''){
					msg_ = replaceAll(msg, emoji)
					if(isHTML(msg_)) {
						return;
					}
					socket.emit('message', '<br><b><span style=\'txt\'>'+username+"</b>> "+msg_+'</span>', username);
					document.getElementById("send_message").reset()
				}
			});
			pings = 1
            socket.on('message', function(fmsg, usern){
			if (!document.onfocus){
				if(usern!=username){
					if(pings == 1){
						document.getElementById("ping").play()
					}
				}
			}
			  document.getElementById('messages').innerHTML += fmsg;
            });
		
			});
			$(function() {
				$('input, textarea, select').focus(function() {
					selectedInput = this;
				}).blur(function(){
					selectedInput = null;
				});
			});
		</script>
		<span class="credits">Made by Creepi (0x-fox) and Ad2017 (ad2017gd)</span><br>
		<a class="credits" href="https://github.com/0x-fox/NetTalk">GitHub repo</a><br>
		<span class="credits+">By using this service, you agree to the </span><a href="/pages/tos.html" class="credits">ToS</a>
		<div id="mscroll">
		<span id="messages"></span>
		</div>
		<form autocomplete="off" id="send_message" action="javascript:void(0)">
		<input id="user_message" list="emojis" name="inputBox">
		<button id="send">Send</button>
		<datalist id="emojis">
		<option value=":grin:">
		<option value=":joy:">
		<option value=":smiley:">
		<option value=":sunglasses:">
		<option value=":neutral:">
		<option value=":sad:">
		<option value=":angry:">
		<option value=":cry:">
		<option value=":shrug:">
		<option value=":thinking:">
		<option value=":100:">
		<option value=":fire:">
		</datalist>
		</form>
		<button onclick="darkMode()" id="darkmode">Dark mode (OFF)</button>
		<button onclick="mute()" id="mute">Pings (ON)</button>
		<div id="mscroll2">
		<span>User list:</span>
		<span id="user_list"></span>
		</div>
		<br>
		<br>
		<br>
		<script>
			$("#mscroll").css("max-height", 400);
			$("#mscroll").css("overflow", "auto");
			$("#mscroll").css("height", 400);
			
			$("#mscroll2").css("max-height", 100);
			$("#mscroll2").css("overflow", "auto");
			$("#mscroll2").css("height", 100);
			$("#mscroll2").css("text-align", "right");
			
			function mute(){
				if(pings == 0){
					pings = 1
					document.getElementById('mute').innerHTML = "Pings (ON)"
				} else {
					pings = 0
					document.getElementById('mute').innerHTML = "Pings (OFF)"
				}
			}
			function darkMode(){
				button = document.getElementById('darkmode')
				if(button.innerHTML == "Dark mode (OFF)"){
					$("#bg").css("background-image", "none");
					$("#bg").css("background-color", "#202020");
					$("button").css("background-image", "none");
					$("button").css("background-color", "#000000");
					$("input").css("background-color", "#484848");
					$("span").css("color", "#FFFFFF");
					button.innerHTML = "Dark mode (ON)";
				} else {
					$("#bg").css("background-image", "linear-gradient(Fuchsia, CornflowerBlue)");
					$("#bg").css("background-color", "rgb(69,75,0)");
					$("button").css("background-image", "linear-gradient(GoldenRod, Gold)");
					$("input").css("background-color", "#FFFFFF");
					$("span").css("color", "#000000");
					button.innerHTML = "Dark mode (OFF)";
				}
			}
			
			
			window.setInterval(function() {
				var elem = document.getElementById('mscroll');
				elem.scrollTop = elem.scrollHeight;
			}, 500);
			var input = document.getElementById("user_message");
			input.addEventListener("keyup", function(event) {
				if (event.keyCode === 13) {
					if($('#user_message').val() != "") {
						document.getElementById("send").click();
						document.getElementById("send_message").reset()
					}
				}
			})
		</script>
	</body>
</html>
<audio id="ping">
	<source src="/assets/ping.mp3" type="audio/mpeg">
</audio>